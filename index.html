<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>crema AR</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
  body { margin:0; overflow:hidden; }
</style>
</head>

<body>
<a-scene embedded arjs="sourceType: webcam; debugUIEnabled:false;">

  <!-- crema1 -->
  <a-image
    id="crema1"
    src="crema1.png"
    position="0 0 -2"
    width="1"
    height="1"
    material="opacity:1"
    gesture-handler
  ></a-image>

  <!-- crema2 -->
  <a-image
    id="crema2"
    src="crema2.png"
    position="0 0 -2"
    width="1"
    height="1"
    material="opacity:0"
    visible="true"
    gesture-handler
  ></a-image>

  <a-entity camera></a-entity>
</a-scene>

<script>
// フェード切り替え
let switched = false;
document.addEventListener("click", () => {
  if (switched) return;
  switched = true;

  fade(document.querySelector("#crema1"), 1, 0);
  fade(document.querySelector("#crema2"), 0, 1);
});

function fade(el, from, to) {
  let opacity = from;
  const step = (to > from) ? 0.02 : -0.02;

  const timer = setInterval(() => {
    opacity += step;
    el.setAttribute("material", "opacity", opacity);

    if ((step > 0 && opacity >= to) || (step < 0 && opacity <= to)) {
      el.setAttribute("material", "opacity", to);
      clearInterval(timer);
    }
  }, 30);
}

// ジェスチャー操作
AFRAME.registerComponent("gesture-handler", {
  init: function () {
    this.startDist = null;
    this.startAngle = null;

    this.el.sceneEl.addEventListener("touchmove", this.onMove.bind(this), { passive:false });
  },

  onMove: function (e) {
    e.preventDefault();
    const obj = this.el.object3D;

    // 1本指：移動
    if (e.touches.length === 1) {
      const t = e.touches[0];
      obj.position.x += (t.movementX || 0) * 0.005;
      obj.position.y -= (t.movementY || 0) * 0.005;
    }

    // 2本指：拡大縮小 + Y軸回転
    if (e.touches.length === 2) {
      const dx = e.touches[0].pageX - e.touches[1].pageX;
      const dy = e.touches[0].pageY - e.touches[1].pageY;
      const dist = Math.hypot(dx, dy);
      const angle = Math.atan2(dy, dx);

      if (this.startDist) {
        const scale = dist / this.startDist;
        obj.scale.multiplyScalar(scale);

        // Y軸回転（手前↔奥）
        obj.rotation.y += angle - this.startAngle;
      }

      this.startDist = dist;
      this.startAngle = angle;
    }
  }
});
</script>

</body>
</html>
