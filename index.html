<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Tap AR Image</title>

<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

<style>
  body { margin:0; overflow:hidden; }
</style>
</head>

<body>
<a-scene
  embedded
  arjs="sourceType: webcam; debugUIEnabled:false;"
>

  <!-- 最初から表示される画像 -->
  <a-image
    src="crema1.png"
    position="0 0 -2"
    width="1.2"
    height="1.2"
  ></a-image>

  <!-- タップで出現する画像 -->
  <a-image
    id="crema2"
    src="crema2.png"
    position="0 -0.5 -2"
    width="1"
    height="1"
    visible="false"
    animation="property: position;
               from: 0 -0.8 -2;
               to:   0 0 -2;
               dur: 800;
               easing: easeOutCubic"
    gesture-handler
  ></a-image>

  <a-entity camera></a-entity>
</a-scene>

<script>
let shown = false;

document.addEventListener("click", () => {
  if (shown) return;
  shown = true;

  const img = document.querySelector("#crema2");
  img.setAttribute("visible", true);
});
</script>

<script>
AFRAME.registerComponent("gesture-handler", {
  init: function () {
    this.startDist = null;
    this.startRot = null;
    this.el.sceneEl.addEventListener("touchmove", this.onMove.bind(this), { passive:false });
  },

  onMove: function (e) {
    e.preventDefault();
    const el = this.el;

    // 1本指：移動
    if (e.touches.length === 1) {
      el.object3D.position.x += (e.touches[0].movementX || 0) * 0.005;
      el.object3D.position.y -= (e.touches[0].movementY || 0) * 0.005;
    }

    // 2本指：拡大・回転
    if (e.touches.length === 2) {
      const dx = e.touches[0].pageX - e.touches[1].pageX;
      const dy = e.touches[0].pageY - e.touches[1].pageY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const angle = Math.atan2(dy, dx);

      if (this.startDist) {
        const scale = dist / this.startDist;
        el.object3D.scale.multiplyScalar(scale);
        el.object3D.rotation.z += angle - this.startRot;
      }

      this.startDist = dist;
      this.startRot = angle;
    }
  }
});
</script>

</body>
</html>
